@page "/manage-incomes/{ProfileId}/add"

@using TaxCalculator.WebFrontend.Models
@using TaxCalculator.WebFrontend.Shared.FormInputs
@using TaxCalculator.WebFrontend.Validation
@using TaxCalculator.Cqrs.Contracts.Bus
@using TaxCalculator.WebFrontend.Pages.Incomes.Commands
@using TaxCalculator.Cqrs.Contracts

@inject ICommandBus _commandBus
@inject NavigationManager _navigationManager

<PageTitle>Add Income</PageTitle>

<div>
    <div>
        <h3>Add income</h3>
    </div>
    <br />
    <div>
        <EditForm OnSubmit="@HandleSubmitAsync" EditContext="@EditContext">
            <Validator TModel="CreateIncomeModel" OnValidated="@(() => this.StateHasChanged())" />
            
            <TextInput Label="Amount"
                       MessageFor="@(() => CreateIncomeModel.Value)"
                       @bind-Value="@CreateIncomeModel.Value" />
            
            <TextInput Label="Income date" 
                       MessageFor="@(() => CreateIncomeModel.IncomeDate)"
                       @bind-Value="@CreateIncomeModel.IncomeDate"/>
            
            <ButtonSubmit IsEnabled="@IsValid" />
        </EditForm>
    </div>
</div>
@code {
    [Parameter]
    public string ProfileId { get; set; }

    private bool IsValid => !EditContext.GetValidationMessages().Any();
    
    private CreateIncomeModel CreateIncomeModel { get; } = new();
    
    private EditContext EditContext { get; set; }

    protected override void OnInitialized()
    {
        CreateIncomeModel.TaxProfileId = Guid.Parse(ProfileId);
        EditContext = new EditContext(CreateIncomeModel);
    }

    private async Task HandleSubmitAsync()
    {
        var result = await _commandBus.DispatchAsync(new CreateIncomeCommand
        {
            Value = CreateIncomeModel.Value,
            TaxProfileId = CreateIncomeModel.TaxProfileId,
            IncomeDate = DateTime.Parse(CreateIncomeModel.IncomeDate)
        });
        
        if (result.Status == CommandStatus.Success)
        {
            _navigationManager.NavigateTo($"/manage-incomes/{ProfileId}");
        }
    }
}